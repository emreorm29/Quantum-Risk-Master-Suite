import streamlit as st
import pandas as pd
import numpy as np
import sqlite3
import yfinance as yf
import subprocess
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime

# --- 1. SÄ°STEM VE VERÄ°TABANI KURULUMU ---
def init_db():
    conn = sqlite3.connect('quantum_ultimate.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS risk_logs 
                 (id INTEGER PRIMARY KEY, title TEXT, category TEXT, 
                  value REAL, summary TEXT, date TEXT)''')
    conn.commit()
    conn.close()

def save_to_db(title, category, value, summary):
    conn = sqlite3.connect('quantum_ultimate.db')
    conn.execute("INSERT INTO risk_logs (title, category, value, summary, date) VALUES (?,?,?,?,?)",
                 (title, category, value, summary, datetime.now().strftime("%Y-%m-%d %H:%M:%S")))
    conn.commit()
    conn.close()

def notify(title, msg):
    try: subprocess.run(["notify-send", title, msg])
    except: pass

# --- 2. HASSAS GÄ°RDÄ° BÄ°LEÅENÄ° (Slider + Sync Input) ---
def precise_input(label, min_v, max_v, default_v, step_v, key_id):
    st.write(f"**{label}**")
    col_s1, col_s2 = st.columns([3, 1])
    with col_s2:
        num_val = st.number_input(f"n_{key_id}", min_value=float(min_v), max_value=float(max_v), 
                                  value=float(default_v), step=float(step_v), label_visibility="collapsed")
    with col_s1:
        val = st.slider(f"s_{key_id}", min_value=float(min_v), max_value=float(max_v), 
                        value=num_val, step=float(step_v), label_visibility="collapsed")
    return val

# --- 3. ANALÄ°TÄ°K MOTORLAR ---
class RiskEngine:
    @staticmethod
    def get_annuity(age, rate):
        remaining = max(0, 75 - age)
        v = 1 / (1 + (rate/100))
        if rate == 0: return remaining
        return (1 - v**remaining) / (1 - v)

    @staticmethod
    def draw_credit_heatmap(ead):
        pd_range = np.linspace(0.1, 20.0, 10)
        lgd_range = np.linspace(10.0, 100.0, 10)
        matrix = np.array([[(p/100) * (l/100) * ead for p in pd_range] for l in lgd_range])
        
        fig, ax = plt.subplots(figsize=(10, 5))
        sns.heatmap(matrix, annot=False, cmap="RdYlGn_r", 
                    xticklabels=[f"%{x:.1f}" for x in pd_range],
                    yticklabels=[f"%{y:.0f}" for y in lgd_range], ax=ax)
        plt.title(f"Kredi Stres Testi (EAD: {ead:,.0f} TL)")
        plt.xlabel("TemerrÃ¼t OlasÄ±lÄ±ÄŸÄ± (PD)")
        plt.ylabel("KayÄ±p OranÄ± (LGD)")
        return fig

# --- 4. ANA ARAYÃœZ ---
st.set_page_config(page_title="Quantum Ultimate Risk Suite", layout="wide")
init_db()

st.sidebar.title("ğŸ’ Quantum Ultimate")
module = st.sidebar.selectbox("ModÃ¼ller", 
    ["ğŸ›¡ï¸ AktÃ¼eryal Tazminat", "ğŸ’° YatÄ±rÄ±m & NPV", "ğŸ¦ Kredi Riski (Basel III)", "ğŸ“œ ArÅŸiv"])

# CanlÄ± Veri Butonu
if st.sidebar.button("ğŸŒ CanlÄ± Piyasa GÃ¼ncelle"):
    try:
        tnx = yf.Ticker("^TNX").history(period="1d")['Close'].iloc[-1]
        st.session_state['live_rate'] = tnx
        notify("Piyasa GÃ¼ncellendi", f"ABD 10Y: %{tnx:.2f}")
    except: st.sidebar.error("Veri Ã§ekilemedi.")

# --- MODÃœL Ä°ÅLEMLERÄ° ---

if module == "ğŸ›¡ï¸ AktÃ¼eryal Tazminat":
    st.title("ğŸ›¡ï¸ AktÃ¼eryal Tazminat Terminali")
    c1, c2 = st.columns(2)
    with c1:
        name = st.text_input("Maktul/Dosya AdÄ±", "Ahmet YÄ±lmaz")
        age = st.number_input("YaÅŸ", 0, 90, 35)
        income = st.number_input("AylÄ±k Gelir (TL)", value=45000)
        rate = precise_input("Teknik Faiz (%)", 0.0, 20.0, st.session_state.get('live_rate', 9.0), 0.01, "act")
    with c2:
        annuity = RiskEngine.get_annuity(age, rate)
        total = annuity * income * 12
        st.metric("Toplam Tazminat", f"{total:,.2f} TL")
        if st.button("Kaydet"):
            save_to_db(name, "AktÃ¼eryal", total, f"YaÅŸ: {age}, Faiz: %{rate}")
            st.success("ArÅŸive eklendi.")

elif module == "ğŸ’° YatÄ±rÄ±m & NPV":
    st.title("ğŸ’° YatÄ±rÄ±m Analizi (NPV)")
    c1, c2 = st.columns(2)
    with c1:
        p_name = st.text_input("Proje", "GiriÅŸim X")
        base = st.number_input("BaÅŸlangÄ±Ã§ Nakit AkÄ±ÅŸÄ±", value=1000000)
        growth = precise_input("YÄ±llÄ±k BÃ¼yÃ¼me (%)", 0.0, 100.0, 10.0, 0.1, "growth")
        disc = precise_input("Ä°skonto OranÄ± (%)", 0.0, 100.0, 15.0, 0.1, "disc")
        years = st.slider("Vade (YÄ±l)", 1, 30, 10)
    with c2:
        cfs = [base * (1 + (growth/100))**t for t in range(years)]
        npv = sum(cf / (1 + (disc/100))**t for t, cf in enumerate(cfs))
        st.metric("Net BugÃ¼nkÃ¼ DeÄŸer", f"{npv:,.2f} TL")
        st.area_chart(cfs)

elif module == "ğŸ¦ Kredi Riski (Basel III)":
    st.title("ğŸ¦ Kredi Riski ve IsÄ± HaritasÄ±")
    c1, c2 = st.columns(2)
    with c1:
        client = st.text_input("MÃ¼ÅŸteri", "A.Å. Holding")
        ead = st.number_input("Risk TutarÄ± (EAD)", value=5000000)
        pd = precise_input("TemerrÃ¼t OlasÄ±lÄ±ÄŸÄ± (PD %)", 0.1, 20.0, 5.0, 0.05, "pd")
        lgd = precise_input("KayÄ±p OranÄ± (LGD %)", 10.0, 100.0, 45.0, 0.1, "lgd")
    with c2:
        el = (pd/100) * (lgd/100) * ead
        st.metric("Beklenen KayÄ±p (EL)", f"{el:,.2f} TL")
        st.metric("Sermaye YÃ¼kÃ¼ (RWA)", f"{el * 12.5:,.2f} TL")
        summary = f"{client} iÃ§in EL: {el:,.2f} TL. Risk dÃ¼zeyi PD:%{pd} ile analiz edildi."
        st.info(f"**YÃ¶netici Ã–zeti:** {summary}")

    st.divider()
    st.subheader("ğŸ”¥ Dinamik Risk IsÄ± HaritasÄ±")
    st.pyplot(RiskEngine.draw_credit_heatmap(ead))
    
    if st.button("Risk Analizini Kaydet"):
        save_to_db(client, "Kredi Riski", el, summary)
        notify("KayÄ±t BaÅŸarÄ±lÄ±", f"{client} arÅŸive eklendi.")

elif module == "ğŸ“œ ArÅŸiv":
    st.title("ğŸ“œ Risk Analiz ArÅŸivi")
    conn = sqlite3.connect('quantum_ultimate.db')
    df = pd.read_sql_query("SELECT * FROM risk_logs ORDER BY date DESC", conn)
    st.dataframe(df, use_container_width=True)
    if st.button("ArÅŸivi SÄ±fÄ±rla"):
        conn.execute("DELETE FROM risk_logs")
        conn.commit()
        st.rerun()
    conn.close()

st.sidebar.markdown("---")
st.sidebar.caption("Arch Linux Quantum Master Ultimate v3.0")

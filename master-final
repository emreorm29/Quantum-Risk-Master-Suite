import streamlit as st
import pandas as pd
import numpy as np
import sqlite3
import subprocess
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime
from fpdf import FPDF

# --- 1. SÄ°STEM VE VERÄ°TABANI ---
def init_db():
    conn = sqlite3.connect('quantum_ultimate.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS risk_logs 
                 (id INTEGER PRIMARY KEY, title TEXT, category TEXT, 
                  value REAL, summary TEXT, date TEXT)''')
    conn.commit()
    conn.close()

def save_to_db(title, category, value, summary):
    conn = sqlite3.connect('quantum_ultimate.db')
    conn.execute("INSERT INTO risk_logs (title, category, value, summary, date) VALUES (?,?,?,?,?)",
                 (title, category, value, summary, datetime.now().strftime("%Y-%m-%d %H:%M:%S")))
    conn.commit()
    conn.close()

# --- 2. PDF MOTORU ---
class RiskReport(FPDF):
    def header(self):
        self.set_font('Arial', 'B', 15)
        self.cell(0, 10, 'QUANTUM RISK MASTER - ANALIZ RAPORU', 0, 1, 'C')
        self.ln(10)

def generate_pdf(title, category, value, summary):
    pdf = RiskReport()
    pdf.add_page()
    pdf.set_font("Arial", size=12)
    clean_summary = summary.replace('Ä±','i').replace('ÄŸ','g').replace('Ã¼','u').replace('ÅŸ','s').replace('Ã¶','o').replace('Ã§','c').replace('Ä°','I')
    pdf.cell(200, 10, txt=f"Rapor Tarihi: {datetime.now().strftime('%d/%m/%Y %H:%M')}", ln=1)
    pdf.cell(200, 10, txt=f"Proje: {title}", ln=1)
    pdf.cell(200, 10, txt=f"Kategori: {category}", ln=1)
    pdf.ln(5)
    pdf.set_font("Arial", 'B', 14)
    pdf.cell(200, 10, txt=f"HESAPLANAN DEGER: {value:,.2f} TL", ln=1)
    pdf.ln(5)
    pdf.set_font("Arial", size=11)
    pdf.multi_cell(0, 10, txt=f"Detaylar:\n{clean_summary}")
    return pdf.output(dest='S').encode('latin-1')

# --- 3. YARDIMCI BÄ°LEÅENLER ---
def precise_input(label, min_v, max_v, default_v, step_v, key_id):
    st.write(f"**{label}**")
    col_s1, col_s2 = st.columns([3, 1])
    with col_s2:
        num_val = st.number_input(f"n_{key_id}", min_value=float(min_v), max_value=float(max_v), 
                                  value=float(default_v), step=float(step_v), label_visibility="collapsed")
    with col_s1:
        val = st.slider(f"s_{key_id}", min_value=float(min_v), max_value=float(max_v), 
                        value=num_val, step=float(step_v), label_visibility="collapsed")
    return val

# --- 4. ANA PROGRAM ---
st.set_page_config(page_title="Quantum Ultimate Suite", layout="wide")
init_db()

st.sidebar.title("ğŸ’ Quantum Ultimate")
module = st.sidebar.selectbox("ModÃ¼ller", 
    ["ğŸ›¡ï¸ AktÃ¼eryal Tazminat", "ğŸ’° YatÄ±rÄ±m & NPV", "ğŸ¦ Kredi Riski (Basel III)", "ğŸ“œ ArÅŸiv"])

# --- MODÃœL: AKTÃœERYAL ---
if module == "ğŸ›¡ï¸ AktÃ¼eryal Tazminat":
    st.title("ğŸ›¡ï¸ AktÃ¼eryal Tazminat HesabÄ±")
    c1, c2 = st.columns(2)
    with c1:
        name = st.text_input("Dosya AdÄ±", "Vaka 001")
        age = st.number_input("YaÅŸ", 0, 90, 35)
        income = st.number_input("AylÄ±k Net Gelir", value=45000)
        rate = precise_input("Teknik Faiz (%)", 0.0, 20.0, 9.0, 0.01, "act")
    with c2:
        rem = max(0, 75 - age)
        v = 1 / (1 + (rate/100))
        annuity = (1 - v**rem) / (1 - v) if rate > 0 else rem
        total = annuity * income * 12
        st.metric("Hesaplanan Tazminat", f"{total:,.2f} TL")
        if st.button("Kaydet ve Raporla"):
            summary = f"Yas {age} icin %{rate} faizle hesaplanan yukumluluk."
            save_to_db(name, "Aktueryal", total, summary)
            st.download_button("ğŸ“¥ PDF Indir", data=generate_pdf(name, "Aktueryal", total, summary), file_name=f"{name}.pdf")

# --- MODÃœL: YATIRIM & NPV (EKLEDÄ°ÄÄ°MÄ°Z KISIM) ---
elif module == "ğŸ’° YatÄ±rÄ±m & NPV":
    st.title("ğŸ’° YatÄ±rÄ±m Analizi ve Net BugÃ¼nkÃ¼ DeÄŸer (NPV)")
    col1, col2 = st.columns([1, 1])
    
    with col1:
        proje_adi = st.text_input("Proje/YatÄ±rÄ±m AdÄ±", "GÃ¼neÅŸ Enerjisi Santrali")
        initial_investment = st.number_input("BaÅŸlangÄ±Ã§ YatÄ±rÄ±m Maliyeti (TL)", value=1000000, step=50000)
        discount_rate = precise_input("Ä°skonto OranÄ± (WACC %)", 0.0, 50.0, 15.0, 0.1, "npv_rate")
        years = st.slider("Analiz SÃ¼resi (YÄ±l)", 1, 20, 5)
        
    with col2:
        st.write("**YÄ±llÄ±k Beklenen Net Nakit AkÄ±ÅŸlarÄ±**")
        cash_flows = []
        for i in range(years):
            cf = st.number_input(f"YÄ±l {i+1} Nakit AkÄ±ÅŸÄ± (TL)", value=300000, key=f"cf_{i}")
            cash_flows.append(cf)
        
        # NPV Hesaplama
        npv = -initial_investment
        for t, cf in enumerate(cash_flows):
            npv += cf / (1 + (discount_rate/100))**(t+1)
        
        st.divider()
        if npv > 0:
            st.success(f"PROJE KARLI: NPV = {npv:,.2f} TL")
            status = "Yatirim yapilabilir (Pozitif NPV)."
        else:
            st.error(f"PROJE ZARARDA: NPV = {npv:,.2f} TL")
            status = "Yatirim verimli degil (Negatif NPV)."

    if st.button("ğŸ“Š YatÄ±rÄ±m Analizini Kaydet ve Raporla"):
        summary = f"Maliyet: {initial_investment} TL, Sure: {years} yil, WACC: %{discount_rate}. {status}"
        save_to_db(proje_adi, "Yatirim-NPV", npv, summary)
        st.download_button("ğŸ“¥ Analiz Raporunu Ä°ndir", data=generate_pdf(proje_adi, "NPV Analizi", npv, summary), file_name=f"{proje_adi}_NPV.pdf")

# --- MODÃœL: KREDÄ° RÄ°SKÄ° ---
elif module == "ğŸ¦ Kredi Riski (Basel III)":
    st.title("ğŸ¦ Basel III Kredi Riski Analizi")
    c1, c2 = st.columns(2)
    with c1:
        client = st.text_input("MÃ¼ÅŸteri", "Kurumsal PortfÃ¶y")
        ead = st.number_input("Risk TutarÄ± (EAD)", value=5000000)
        pd_val = precise_input("PD (%)", 0.1, 20.0, 5.0, 0.05, "pd")
        lgd_val = precise_input("LGD (%)", 10.0, 100.0, 45.0, 0.1, "lgd")
    with c2:
        el = (pd_val/100) * (lgd_val/100) * ead
        st.metric("Beklenen KayÄ±p (EL)", f"{el:,.2f} TL")
        if st.button("Kaydet ve PDF Ãœret"):
            summary = f"EAD: {ead} TL, PD: %{pd_val}, LGD: %{lgd_val} bazli Basel III analizi."
            save_to_db(client, "Kredi Riski", el, summary)
            st.download_button("ğŸ“¥ Raporu Ä°ndir", data=generate_pdf(client, "Kredi Riski", el, summary), file_name="kredi_rapor.pdf")

# --- MODÃœL: ARÅÄ°V ---
elif module == "ğŸ“œ ArÅŸiv":
    st.title("ğŸ“œ KayÄ±tlÄ± Analizler")
    conn = sqlite3.connect('quantum_ultimate.db')
    df = pd.read_sql_query("SELECT * FROM risk_logs ORDER BY date DESC", conn)
    st.dataframe(df, use_container_width=True)
    conn.close()

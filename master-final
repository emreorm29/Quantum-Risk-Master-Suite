import streamlit as st
import pandas as pd
import numpy as np
import sqlite3
import matplotlib.pyplot as plt
import seaborn as sns
import yfinance as yf
from datetime import datetime
from fpdf import FPDF
import os

# --- 1. SÄ°STEM VE VERÄ°TABANI FONKSÄ°YONLARI ---
def init_db():
    conn = sqlite3.connect('quantum_ultimate.db')
    conn.execute('''CREATE TABLE IF NOT EXISTS risk_logs 
                 (id INTEGER PRIMARY KEY, title TEXT, category TEXT, 
                  value REAL, summary TEXT, date TEXT)''')
    conn.commit()
    conn.close()

def save_to_db(title, category, value, summary):
    conn = sqlite3.connect('quantum_ultimate.db')
    conn.execute("INSERT INTO risk_logs (title, category, value, summary, date) VALUES (?,?,?,?,?)",
                 (title, category, value, summary, datetime.now().strftime("%Y-%m-%d %H:%M:%S")))
    conn.commit()
    conn.close()

@st.cache_data(ttl=3600)
def get_live_usd():
    try:
        data = yf.Ticker("USDTRY=X").history(period="1d")
        return data['Close'].iloc[-1]
    except:
        return 35.85 # Hata durumunda varsayÄ±lan kur

# --- 2. PROFESYONEL PDF MOTORU ---
class RiskReport(FPDF):
    def header(self):
        if os.path.exists('logo.png'):
            self.image('logo.png', 10, 8, 30)
        self.set_font('Arial', 'B', 16)
        self.cell(80)
        self.cell(30, 10, 'QUANTUM RISK BLACK EDITION', 0, 1, 'C')
        self.ln(15)

def generate_ultimate_pdf(title, category, value, summary, scenario_df=None, plot_fig=None):
    pdf = RiskReport()
    pdf.add_page()
    def clean(t): return str(t).replace('Ä±','i').replace('ÄŸ','g').replace('Ã¼','u').replace('ÅŸ','s').replace('Ã¶','o').replace('Ã§','c').replace('Ä°','I')
    
    pdf.set_font("Arial", 'B', 12)
    pdf.cell(0, 10, txt=f"Analiz Birimi: {clean(title)} | Kategori: {clean(category)}", ln=1)
    pdf.cell(0, 10, txt=f"Tarih: {datetime.now().strftime('%d/%m/%Y %H:%M')}", ln=1)
    
    pdf.set_fill_color(240, 240, 240)
    pdf.set_font("Arial", 'B', 14)
    pdf.cell(0, 15, txt=f"HESAPLANAN DEGER: {value:,.2f} TL", ln=1, fill=True, align='C')
    
    pdf.set_font("Arial", size=10)
    pdf.multi_cell(0, 8, txt=f"Yonetici Ozeti: {clean(summary)}")

    if scenario_df is not None:
        pdf.ln(5)
        pdf.set_font("Arial", 'B', 11)
        pdf.cell(0, 10, "STRES TESTI SENARYOLARI", ln=1)
        for _, row in scenario_df.iterrows():
            pdf.cell(80, 10, f"{clean(row['Senaryo'])}: {row['KayÄ±p']:,.2f} TL", 1, 1)

    if plot_fig is not None:
        plot_fig.savefig("temp_report.png", bbox_inches='tight', dpi=100)
        pdf.ln(5)
        pdf.image("temp_report.png", x=20, w=160)
        os.remove("temp_report.png")
    
    return pdf.output(dest='S').encode('latin-1')

# --- 3. GÄ°RÄ°Å EKRANI (LOGIN) VE AUTH ---
st.set_page_config(page_title="Quantum Black Edition", layout="wide")
init_db()

if 'auth' not in st.session_state:
    st.session_state.auth = False

def login_screen():
    st.sidebar.title("ğŸ” Quantum SafeGate")
    user = st.sidebar.text_input("KullanÄ±cÄ±")
    pw = st.sidebar.text_input("Åifre", type="password")
    if st.sidebar.button("Sisteme GiriÅŸ"):
        if user == "admin" and pw == "1234": # BurayÄ± kendine gÃ¶re deÄŸiÅŸtirebilirsin
            st.session_state.auth = True
            st.rerun()
        else:
            st.sidebar.error("Yetkisiz EriÅŸim!")

# --- 4. ANA PROGRAM AKIÅI ---
if not st.session_state.auth:
    st.title("ğŸ’ Quantum Risk Master Suite")
    st.info("Bu terminal Arch Linux ortamÄ±nda yÃ¼ksek gÃ¼venlikli aktÃ¼eryal hesaplamalar iÃ§in tasarlanmÄ±ÅŸtÄ±r.")
    st.warning("LÃ¼tfen sol panelden kimlik doÄŸrulamasÄ± yapÄ±nÄ±z.")
    login_screen()
else:
    # --- CANLI VERÄ° PANELÄ° ---
    usd_val = get_live_usd()
    st.sidebar.success(f"Oturum AÃ§Ä±ldÄ±: Admin")
    st.sidebar.metric("CanlÄ± USD/TRY", f"{usd_val:.4f}")
    if st.sidebar.button("Ã‡Ä±kÄ±ÅŸ Yap"):
        st.session_state.auth = False
        st.rerun()

    module = st.sidebar.selectbox("YÃ¶netim Paneli", ["ğŸ“Š Kokpit", "ğŸ›¡ï¸ AktÃ¼eryal", "ğŸ’° YatÄ±rÄ±m & Monte Carlo", "ğŸ¦ Kredi Riski", "ğŸ“œ ArÅŸiv"])

    # --- MODÃœL: KOKPÄ°T ---
    if module == "ğŸ“Š Kokpit":
        st.title("ğŸ“Š YÃ¶netici Risk Kokpiti")
        conn = sqlite3.connect('quantum_ultimate.db')
        df = pd.read_sql_query("SELECT * FROM risk_logs", conn)
        if not df.empty:
            c1, c2, c3 = st.columns(3)
            c1.metric("Toplam Analiz", len(df))
            c2.metric("Risk Hacmi (TL)", f"{df['value'].sum():,.0f}")
            c3.metric("DÃ¶viz KarÅŸÄ±lÄ±ÄŸÄ± ($)", f"${(df['value'].sum() / usd_val):,.0f}")
            st.divider()
            fig_bar, ax_bar = plt.subplots(figsize=(10, 4))
            sns.barplot(data=df, x='category', y='value', ax=ax_bar, palette="viridis")
            st.pyplot(fig_bar)
        else:
            st.info("Sistemde henÃ¼z kayÄ±tlÄ± analiz bulunmamaktadÄ±r.")

    # --- MODÃœL: AKTÃœERYAL ---
    elif module == "ğŸ›¡ï¸ AktÃ¼eryal":
        st.title("ğŸ›¡ï¸ AktÃ¼eryal Tazminat")
        c1, c2 = st.columns(2)
        with c1:
            name = st.text_input("Vaka AdÄ±", "Tazminat Dosya-01")
            age = st.number_input("Mevcut YaÅŸ", 0, 90, 35)
            income = st.number_input("AylÄ±k Gelir (TL)", value=45000)
            rate = st.slider("Teknik Faiz (%)", 0.0, 20.0, 9.0, 0.1)
        with c2:
            rem = max(0, 75 - age)
            v = 1 / (1 + (rate/100))
            ann = (1 - v**rem) / (1 - v) if rate > 0 else rem
            res = ann * income * 12
            st.metric("Hesaplanan YÃ¼kÃ¼mlÃ¼lÃ¼k", f"{res:,.2f} TL")
            if st.button("Kaydet ve Raporla"):
                save_to_db(name, "Aktueryal", res, f"Yas {age}, Faiz %{rate}")
                pdf = generate_ultimate_pdf(name, "Aktueryal", res, f"Yas {age} bazli tazminat.")
                st.download_button("ğŸ“¥ PDF Ä°ndir", data=pdf, file_name=f"{name}.pdf")

    # --- MODÃœL: YATIRIM & MONTE CARLO ---
    elif module == "ğŸ’° YatÄ±rÄ±m & Monte Carlo":
        st.title("ğŸ’° YatÄ±rÄ±m & Monte Carlo Risk DaÄŸÄ±lÄ±mÄ±")
        c1, c2 = st.columns(2)
        with c1:
            p_name = st.text_input("Proje AdÄ±", "Stratejik YatÄ±rÄ±m")
            mu = st.number_input("Beklenen YÄ±llÄ±k Getiri (TL)", value=500000)
            vol = st.slider("OlasÄ± Sapma (Volatilite %)", 5, 50, 20)
        with c2:
            sims = np.random.normal(mu, mu * (vol/100), 1000)
            fig_mc, ax_mc = plt.subplots()
            sns.histplot(sims, kde=True, ax=ax_mc, color="purple")
            st.pyplot(fig_mc)
            if st.button("Analizi ArÅŸive GÃ¶nder"):
                save_to_db(p_name, "Yatirim-MC", mu, f"Vol %{vol}")
                st.success("Kaydedildi.")

    # --- MODÃœL: KREDÄ° RÄ°SKÄ° ---
    elif module == "ğŸ¦ Kredi Riski":
        st.title("ğŸ¦ Kredi Riski & Stres Testi")
        c1, c2 = st.columns(2)
        with c1:
            cl = st.text_input("MÃ¼ÅŸteri", "Kurumsal PortfÃ¶y")
            ead = st.number_input("EAD (Risk TutarÄ±)", value=1000000)
            pd_v = st.slider("PD (OlasÄ±lÄ±k %)", 0.1, 20.0, 5.0)
            lgd_v = st.slider("LGD (KayÄ±p %)", 10.0, 100.0, 45.0)
        el = (pd_v/100) * (lgd_v/100) * ead
        c2.metric("Beklenen KayÄ±p (EL)", f"{el:,.2f} TL")
        
        st.divider()
        scs = {"Ä°yimser": {"p": 0.5, "l": 0.8}, "Beklenen": {"p": 1.0, "l": 1.0}, "KÃ¶tÃ¼mser": {"p": 2.5, "l": 1.5}}
        s_data = []
        for sn, m in scs.items():
            loss = (min(pd_v*m["p"],100)/100) * (min(lgd_v*m["l"],100)/100) * ead
            s_data.append({"Senaryo": sn, "KayÄ±p": loss})
        df_s = pd.DataFrame(s_data)
        
        ct, cg = st.columns(2)
        ct.table(df_s)
        fig_s, ax_s = plt.subplots(figsize=(6,3))
        ax_s.bar(df_s["Senaryo"], df_s["KayÄ±p"], color=['green', 'blue', 'red'])
        cg.pyplot(fig_s)
        
        if st.button("Stres Testi Raporu Ãœret"):
            save_to_db(cl, "Kredi Riski", el, "Basel III Stres Testi")
            pdf = generate_ultimate_pdf(cl, "Kredi Riski", el, "Stres testi analizi.", df_s, fig_s)
            st.download_button("ğŸ“¥ PDF Rapor", data=pdf, file_name=f"{cl}_Risk.pdf")

    # --- MODÃœL: ARÅÄ°V ---
    elif module == "ğŸ“œ ArÅŸiv":
        st.title("ğŸ“œ Analiz ArÅŸivi")
        conn = sqlite3.connect('quantum_ultimate.db')
        st.dataframe(pd.read_sql_query("SELECT * FROM risk_logs ORDER BY date DESC", conn), use_container_width=True)

import streamlit as st
import pandas as pd
import numpy as np
import sqlite3
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime
from fpdf import FPDF

# --- 1. SÄ°STEM VE VERÄ°TABANI ---
def init_db():
    conn = sqlite3.connect('quantum_ultimate.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS risk_logs 
                 (id INTEGER PRIMARY KEY, title TEXT, category TEXT, 
                  value REAL, summary TEXT, date TEXT)''')
    conn.commit()
    conn.close()

def save_to_db(title, category, value, summary):
    conn = sqlite3.connect('quantum_ultimate.db')
    conn.execute("INSERT INTO risk_logs (title, category, value, summary, date) VALUES (?,?,?,?,?)",
                 (title, category, value, summary, datetime.now().strftime("%Y-%m-%d %H:%M:%S")))
    conn.commit()
    conn.close()

# --- 2. GELÄ°ÅMÄ°Å PDF MOTORU (SENARYO DESTEKLÄ°) ---
class RiskReport(FPDF):
    def header(self):
        self.set_font('Arial', 'B', 15)
        self.cell(0, 10, 'QUANTUM RISK MASTER - STRATEJIK RAPOR', 0, 1, 'C')
        self.ln(10)

def generate_pdf_v4(title, category, value, summary, scenario_df=None):
    pdf = RiskReport()
    pdf.add_page()
    pdf.set_font("Arial", size=11)
    
    # Karakter temizleme
    def clean(t): return str(t).replace('Ä±','i').replace('ÄŸ','g').replace('Ã¼','u').replace('ÅŸ','s').replace('Ã¶','o').replace('Ã§','c').replace('Ä°','I')
    
    pdf.cell(200, 10, txt=f"Rapor Tarihi: {datetime.now().strftime('%d/%m/%Y %H:%M')}", ln=1)
    pdf.cell(200, 10, txt=f"Analiz Edilen: {clean(title)}", ln=1)
    pdf.ln(5)
    
    pdf.set_font("Arial", 'B', 14)
    pdf.cell(200, 10, txt=f"ANA SONUC: {value:,.2f} TL", ln=1)
    pdf.ln(5)
    
    pdf.set_font("Arial", size=11)
    pdf.multi_cell(0, 8, txt=f"Yonetici Ozeti: {clean(summary)}")
    pdf.ln(10)

    # Senaryo Tablosu Ekleme
    if scenario_df is not None:
        pdf.set_font("Arial", 'B', 12)
        pdf.cell(0, 10, "STRES TESTI SENARYOLARI", ln=1)
        pdf.set_font("Arial", 'B', 10)
        # Header
        pdf.cell(60, 10, "Senaryo", 1)
        pdf.cell(60, 10, "Potansiyel Kayip (TL)", 1)
        pdf.ln()
        # Data
        pdf.set_font("Arial", size=10)
        for _, row in scenario_df.iterrows():
            pdf.cell(60, 10, clean(row['Senaryo']), 1)
            pdf.cell(60, 10, f"{row['KayÄ±p']:,.2f}", 1)
            pdf.ln()
            
    return pdf.output(dest='S').encode('latin-1')

# --- 3. YARDIMCI BÄ°LEÅEN ---
def precise_input(label, min_v, max_v, default_v, step_v, key_id):
    st.write(f"**{label}**")
    col_s1, col_s2 = st.columns([3, 1])
    with col_s2:
        num_val = st.number_input(f"n_{key_id}", min_value=float(min_v), max_value=float(max_v), value=float(default_v), step=float(step_v), label_visibility="collapsed")
    with col_s1:
        val = st.slider(f"s_{key_id}", min_value=float(min_v), max_value=float(max_v), value=num_val, step=float(step_v), label_visibility="collapsed")
    return val

# --- 4. ANA ARAYÃœZ ---
st.set_page_config(page_title="Quantum Ultimate v4.1", layout="wide")
init_db()

st.sidebar.title("ğŸ’ Quantum Ultimate")
module = st.sidebar.selectbox("ModÃ¼ller", ["ğŸ›¡ï¸ AktÃ¼eryal Tazminat", "ğŸ’° YatÄ±rÄ±m & NPV", "ğŸ¦ Kredi Riski (Basel III)", "ğŸ“œ ArÅŸiv"])

if module == "ğŸ›¡ï¸ AktÃ¼eryal Tazminat":
    st.title("ğŸ›¡ï¸ AktÃ¼eryal Tazminat")
    c1, c2 = st.columns(2)
    with c1:
        name = st.text_input("Dosya No", "2026/AKT-01")
        age = st.number_input("Yas", 0, 90, 35)
        income = st.number_input("Aylik Gelir", value=45000)
        rate = precise_input("Teknik Faiz (%)", 0.0, 20.0, 9.0, 0.01, "act")
    with c2:
        rem = max(0, 75 - age)
        v = 1 / (1 + (rate/100))
        annuity = (1 - v**rem) / (1 - v) if rate > 0 else rem
        total = annuity * income * 12
        st.metric("Toplam YÃ¼kÃ¼mlÃ¼lÃ¼k", f"{total:,.2f} TL")
        if st.button("Kaydet ve PDF Ãœret"):
            save_to_db(name, "Aktueryal", total, f"Yas {age}, Faiz %{rate}")
            st.download_button("ğŸ“¥ PDF Raporu", data=generate_pdf_v4(name, "Aktueryal", total, "Aktueryal tazminat hesabi."), file_name=f"{name}.pdf")

elif module == "ğŸ’° YatÄ±rÄ±m & NPV":
    st.title("ğŸ’° YatÄ±rÄ±m ve NPV Analizi")
    c1, c2 = st.columns(2)
    with c1:
        p_name = st.text_input("Proje Ismi", "Yatirim-A")
        inv = st.number_input("Ilk Yatirim", value=1000000)
        disc = precise_input("Iskonto (%)", 0.0, 50.0, 15.0, 0.1, "npv")
        years = st.slider("Vade (Yil)", 1, 10, 5)
    with c2:
        cfs = [st.number_input(f"Yil {i+1}", value=300000, key=f"c_{i}") for i in range(years)]
        npv = -inv + sum([cf / (1 + (disc/100))**(t+1) for t, cf in enumerate(cfs)])
        st.metric("NPV Sonucu", f"{npv:,.2f} TL")
        if st.button("Kaydet"):
            save_to_db(p_name, "NPV", npv, f"Maliyet: {inv}")
            st.success("Arsive eklendi.")

elif module == "ğŸ¦ Kredi Riski (Basel III)":
    st.title("ğŸ¦ Kredi Riski ve Stres Testi")
    c1, c2 = st.columns(2)
    with c1:
        client = st.text_input("Musteri", "Global Holding")
        ead = st.number_input("Risk Tutari (EAD)", value=5000000)
        pd_val = precise_input("PD (%)", 0.1, 20.0, 5.0, 0.05, "pd")
        lgd_val = precise_input("LGD (%)", 10.0, 100.0, 45.0, 0.1, "lgd")
    with c2:
        el = (pd_val/100) * (lgd_val/100) * ead
        st.metric("Beklenen KayÄ±p (EL)", f"{el:,.2f} TL")

    st.divider()
    st.subheader("ğŸ“‰ Senaryo BazlÄ± KarÅŸÄ±laÅŸtÄ±rmalÄ± Rapor")
    
    # Senaryo HazÄ±rlama
    scenarios = {"Ä°yimser": {"p": 0.5, "l": 0.8}, "Beklenen": {"p": 1.0, "l": 1.0}, "KÃ¶tÃ¼mser": {"p": 2.5, "l": 1.5}}
    s_data = []
    for sn, m in scenarios.items():
        s_el = (min(pd_val * m["p"], 100)/100) * (min(lgd_val * m["l"], 100)/100) * ead
        s_data.append({"Senaryo": sn, "KayÄ±p": s_el})
    df_s = pd.DataFrame(s_data)
    
    cola, colb = st.columns(2)
    with cola: st.table(df_s)
    with colb:
        fig, ax = plt.subplots(figsize=(6, 3))
        ax.bar(df_s["Senaryo"], df_s["KayÄ±p"], color=['green', 'blue', 'red'])
        st.pyplot(fig)

    if st.button("ğŸ“„ ArÅŸive Kaydet ve DetaylÄ± PDF Ãœret"):
        summary = f"EAD: {ead} TL bazli analiz. Kotumser senaryoda ciddi risk artisi gÃ¶zlemlenmiÅŸtir."
        save_to_db(client, "Kredi Riski", el, summary)
        pdf_bytes = generate_pdf_v4(client, "Risk", el, summary, df_s)
        st.download_button("ğŸ“¥ DetaylÄ± Analiz PDF'i", data=pdf_bytes, file_name=f"{client}_Analiz.pdf")

elif module == "ğŸ“œ ArÅŸiv":
    st.title("ğŸ“œ Analiz ArÅŸivi")
    conn = sqlite3.connect('quantum_ultimate.db')
    st.dataframe(pd.read_sql_query("SELECT * FROM risk_logs ORDER BY date DESC", conn), use_container_width=True)
    conn.close()
